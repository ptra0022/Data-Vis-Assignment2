{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": "container",
  "height": 360,
  "data": { "url": "data/monthly_state.csv", "format": {"type": "csv"} },

  "transform": [
    { "calculate": "toNumber(datum.year)",   "as": "yearN" },
    { "calculate": "toNumber(datum.month)",  "as": "monthN" },
    { "calculate": "toNumber(datum.deaths)", "as": "deathsN" },

    { "aggregate": [{"op": "sum", "field": "deathsN", "as": "deaths"}],
      "groupby": ["yearN", "monthN"] },

    { "calculate": "pad(format(datum.monthN, ''), 2, '0')", "as": "mm" },
    { "calculate": "datum.yearN + '-' + datum.mm + '-01'",  "as": "dateStr" },
    { "calculate": "toDate(datum.dateStr)",                 "as": "date" },

    { "window": [{ "op": "mean", "field": "deaths", "as": "ma_3m" }],
      "frame": [-1, 1],
      "sort": [{ "field": "date", "order": "ascending" }] }
  ],

  "layer": [
    {
      "mark": { "type": "line", "strokeWidth": 1.5, "color": "#93c5fd" },
      "encoding": {
        "x": { "field": "date", "type": "temporal", "title": null },
        "y": { "field": "deaths", "type": "quantitative", "title": "Monthly deaths" },
        "tooltip": [
          { "field": "date", "type": "temporal", "title": "Month", "format": "%b %Y" },
          { "field": "deaths", "type": "quantitative", "title": "Deaths" }
        ]
      }
    },
    {
      "mark": { "type": "line", "strokeWidth": 2.5, "color": "#1d4ed8" },
      "encoding": {
        "x": { "field": "date", "type": "temporal" },
        "y": { "field": "ma_3m", "type": "quantitative", "title": "Monthly deaths" },
        "tooltip": [
          { "field": "date", "type": "temporal", "title": "Month", "format": "%b %Y" },
          { "field": "ma_3m", "type": "quantitative", "title": "3-mo avg", "format": ".1f" }
        ]
      }
    }
  ],

  "title": { "text": "National Monthly Road Fatalities (counts) with 3-month average", "anchor": "start" },
  "config": { "view": { "stroke": null } }
}
